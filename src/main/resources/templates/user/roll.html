<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="/static/home/styles/bootstrap4/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/static/home/styles/main_styles.css">
    <link rel="stylesheet" type="text/css" href="/static/home/styles/bootstrap4/bootstrap.min.css">
    <link href="/static/home/plugins/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="/static/home/plugins/OwlCarousel2-2.2.1/owl.carousel.css">
    <link rel="stylesheet" type="text/css" href="/static/home/plugins/OwlCarousel2-2.2.1/owl.theme.default.css">
    <link rel="stylesheet" type="text/css" href="/static/home/plugins/OwlCarousel2-2.2.1/animate.css">
    <link rel="stylesheet" type="text/css" href="/static/home/styles/product.css">
    <link rel="stylesheet" type="text/css" href="/static/home/styles/product_responsive.css">
    <title>大转盘</title>
    <style type="text/css">

        #lottery {
            width: 674px;
            height: 684px;
            margin: 20px auto 0;
            background: url(/static/images/roll/bg.jpg) no-repeat;
            padding: 50px 55px;
        }
        
        #lottery table td {
            width: 142px;
            height: 142px;
            text-align: center;
            vertical-align: middle;
            font-size: 24px;
            color: #333;
            font-index: -999
        }
        
        #lottery table td a {
            width: 284px;
            height: 284px;
            line-height: 150px;
            display: block;
            text-decoration: none;
        }
        
        #lottery table td.active {
            background-color: #ea0000;
        }
    </style>

</head>

<body>
    <div class="super_container">
        <!-- Header -->
        <header th:replace="userCommon::Header"></header>
        <div style="position: relative;top: 20%;margin-top: 10%;">
            <div id="lottery" th:points="${session.loggedUser.points}" >
                <table border="0" cellpadding="0" cellspacing="0" >
                    <tr>
                        <td class="lottery-unit lottery-unit-0"><img th:src="${goods_0.image}" style="max-height: 142px;max-width: 142px"></td>
                        <td class="lottery-unit lottery-unit-1"><img th:src="${goods_1.image}" style="max-height: 142px;max-width: 142px"></td>
                        <td class="lottery-unit lottery-unit-2"><img th:src="${goods_2.image}" style="max-height: 142px;max-width: 142px"></td>
                        <td class="lottery-unit lottery-unit-3"><img th:src="${goods_3.image}" style="max-height: 142px;max-width: 142px"></td>
                    </tr>
                    <tr>
                        <td class="lottery-unit lottery-unit-11"><img th:src="${goods_11.image}" style="max-height: 142px;max-width: 142px"></td>
                        <td colspan="2" rowspan="2">
                            <a href="#"></a>
                        </td>
                        <td class="lottery-unit lottery-unit-4"><img th:src="${goods_4.image}" style="max-height: 142px;max-width: 142px"></td>
                    </tr>
                    <tr>
                        <td class="lottery-unit lottery-unit-10"><img th:src="${goods_10.image}" style="max-height: 142px;max-width: 142px"></td>
                        <td class="lottery-unit lottery-unit-5"><img th:src="${goods_5.image}" style="max-height: 142px;max-width: 142px"></td>
                    </tr>
                    <tr>
                        <td class="lottery-unit lottery-unit-9"><img th:src="${goods_9.image}" style="max-height: 142px;max-width: 142px"></td>
                        <td class="lottery-unit lottery-unit-8"><img th:src="${goods_8.image}" style="max-height: 142px;max-width: 142px"></td>
                        <td class="lottery-unit lottery-unit-7"><img th:src="${goods_7.image}" style="max-height: 142px;max-width: 142px"></td>
                        <td class="lottery-unit lottery-unit-6"><img th:src="${goods_6.image}" style="max-height: 142px;max-width: 142px"></td>
                    </tr>
                </table>
            </div>
            <div >
                <marquee  direction="up" scrolldelay="1000" scrollamount="50" style="margin-left: 35%">
                    <ul th:each="priceUser:${priceUserList}">
                        <li style='list-style:none;padding:5px;' th:text="${'中奖用户：' + priceUser.username + '   中奖商品:' + priceUser.goodsName + '时间:' + #dates.format(priceUser.createTime,'yyyy-MM-dd HH:mm:ss')}">中奖用户:1895****027 2019-04-01 04:18:15</li>
                    </ul>
                </marquee>
            </div>
        </div>
    </div>



    <script src="/static/home/js/jquery-3.2.1.min.js"></script>
    <script src="/static/home/styles/bootstrap4/popper.js"></script>
    <script src="/static/home/styles/bootstrap4/bootstrap.min.js"></script>
    <script src="/static/home/plugins/greensock/TweenMax.min.js"></script>
    <script src="/static/home/plugins/greensock/TimelineMax.min.js"></script>
    <script src="/static/home/plugins/scrollmagic/ScrollMagic.min.js"></script>
    <script src="/static/home/plugins/greensock/animation.gsap.min.js"></script>
    <script src="/static/home/plugins/greensock/ScrollToPlugin.min.js"></script>
    <script src="/static/home/plugins/OwlCarousel2-2.2.1/owl.carousel.js"></script>
    <script src="/static/home/plugins/Isotope/isotope.pkgd.min.js"></script>
    <script src="/static/home/plugins/easing/easing.js"></script>
    <script src="/static/home/plugins/parallax-js-master/parallax.min.js"></script>
    <script src="/static/home/js/product.js"></script>
    <script type="text/javascript" th:replace="userCommon::categoties"></script>
    <script type="text/javascript">
        var lottery = {
            index: -1, //当前转动到哪个位置，起点位置
            count: 0, //总共有多少个位置
            timer: 0, //setTimeout的ID，用clearTimeout清除
            speed: 20, //初始转动速度
            times: 0, //转动次数
            cycle: 50, //转动基本次数：即至少需要转动多少次再进入抽奖环节
            prize: -1, //中奖位置
            init: function(id) {
                if ($("#" + id).find(".lottery-unit").length > 0) {
                    $lottery = $("#" + id);
                    $units = $lottery.find(".lottery-unit");
                    this.obj = $lottery;
                    this.count = $units.length;
                    $lottery.find(".lottery-unit-" + this.index).addClass("active");
                };
            },
            roll: function() {
                var index = this.index;
                var count = this.count;
                var lottery = this.obj;
                $(lottery).find(".lottery-unit-" + index).removeClass("active");
                index += 1;
                if (index > count - 1) {
                    index = 0;
                };
                $(lottery).find(".lottery-unit-" + index).addClass("active");
                this.index = index;
                return false;
            },
            stop: function(index) {
                this.prize = index;
                return false;
            }
        };
        var priceMessage ;
        function awardAjaxIndex() {
            $.ajax({
                async:false,
                url:'/randomPrice',
                type:'post',
                dataType:'json',
                success:function (result) {
                    if (result.state==1){
                        lottery.prize=result.data;
                        priceMessage = "恭喜您中将了，奖品已发送至您的库存";
                    }else if(result.state==0){
                        priceMessage = result.msg;
                    }
                    else {
                        alert('抽奖功能异常，请稍后再试');
                        window.location.reload();
                    }

                },
                error:function () {
                    alert('抽奖功能异常，请稍后再试');
                }
            });
        }

        function roll() {
            lottery.times += 1;
            lottery.roll();
            if ((lottery.times > lottery.cycle + 10) && lottery.prize == lottery.index) {
                clearTimeout(lottery.timer);
                lottery.prize = -1;
                lottery.times = 0;
                click = false;
            } else {
                if (lottery.times < lottery.cycle) {
                    lottery.speed -= 10;
                } else if (lottery.times == lottery.cycle) {
                    awardAjaxIndex();
                } else {
                    if (lottery.times > lottery.cycle + 10 && ((lottery.prize == 0 && lottery.index == 7) || lottery.prize == lottery.index + 1)) {
                        lottery.speed += 110;
                    } else {
                        lottery.speed += 20;
                    }
                }
                if (lottery.speed < 40) {
                    lottery.speed = 40;
                };
                //console.log(lottery.times+'^^^^^^'+lottery.speed+'^^^^^^^'+lottery.prize);
                lottery.timer = setTimeout(roll, lottery.speed);
            }
            return false;
        }

        var click = false;

        $(function() {
            lottery.init('lottery');
            $("#lottery a").click(function() {
                if (click) {
                    return false;

                } else {
                    lottery.speed = 100;
                    roll();
                    click = true;
                    setTimeout(function() {
                        alert(priceMessage);
                        window.location.reload();
                    }, 8000);
                    return false;
                }
            });
        });
    </script>

</body>
</html>